<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>An√°lise T√©cnica ‚Äî Royal Broker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="analise">
  <div class="ana-center">
    <header class="ana-head">
      <h1 class="section-title sparkle">An√°lise T√©cnica</h1>
      <button class="btn-turq small" onclick="voltarPortal()">‚¨Ö Voltar</button>
    </header>

    <div class="ana-controls">
      <div class="control">
        <label>Ativo</label>
        <div class="select-with-logo">
          <img id="anaLogo" src="img/petr4.png" alt="Logo" class="logo-mini big">
          <select id="anaSymbol" class="rb-input input-royal-focus"></select>
        </div>
      </div>
      <div class="control">
        <label>Intervalo</label>
        <select id="anaInterval" class="rb-input input-royal-focus">
          <option value="10">10s</option>
          <option value="60" selected>1m</option>
          <option value="300">5m</option>
          <option value="1800">30m</option>
          <option value="3600">1h</option>
          <option value="86400">1d</option>
          <option value="604800">1w</option>
        </select>
      </div>
      <div class="control">
        <label>Tipo</label>
        <select id="anaType" class="rb-input input-royal-focus">
          <option value="line">Linha</option>
          <option value="candle" selected>Candlestick</option>
        </select>
      </div>
    </div>

    <canvas id="kChart" width="900" height="380" class="rt-canvas" aria-label="Gr√°fico"></canvas>
    <div class="hint">Passe o mouse para ver data/hora, abertura, m√°xima, m√≠nima e fechamento.</div>

    <div class="analise-tools panel panel-royal-outline">
      <h3 class="panel-title">Ferramentas de An√°lise</h3>
      <div class="tools-grid">
        <div class="tool-card">
          <div class="tool-icon">üìä</div>
          <h4>Indicadores T√©cnicos</h4>
          <p>RSI, MACD, M√©dias M√≥veis e mais</p>
          <button class="btn-royal small" onclick="abrirIndicadores()">Ver Indicadores</button>
        </div>
        <div class="tool-card">
          <div class="tool-icon">üéØ</div>
          <h4>N√≠veis de Suporte/Resist√™ncia</h4>
          <p>Identifica√ß√£o autom√°tica de n√≠veis importantes</p>
          <button class="btn-royal small" onclick="abrirNiveis()">Ver N√≠veis</button>
        </div>
        <div class="tool-card">
          <div class="tool-icon">üìà</div>
          <h4>Padr√µes de Candlestick</h4>
          <p>Reconhecimento de padr√µes de revers√£o</p>
          <button class="btn-royal small" onclick="abrirPadroes()">Ver Padr√µes</button>
        </div>
      </div>
      
      <!-- MINI CARTEIRA -->
      <div class="mini-carteira">
        <h4>üìä Minha Carteira</h4>
        <div id="miniCarteiraList" class="mini-carteira-list"></div>
      </div>
      
      <div class="ana-actions">
        <button class="btn-buy" onclick="abrirOperacao('Compra')">Comprar</button>
        <button class="btn-sell" onclick="abrirOperacao('Venda')">Vender</button>
      </div>
    </div>
  </div>

  <!-- Modal de Opera√ß√£o -->
  <div id="modalOperacao" class="rb-modal" role="dialog" aria-modal="true" aria-labelledby="modalOperacaoTitle">
    <div class="modal-head">
      <h3 id="modalOperacaoTitle">Opera√ß√£o de <span id="tipoOperacao">Compra</span></h3>
      <button class="modal-x" onclick="hideModal('modalOperacao')" aria-label="Fechar">√ó</button>
    </div>
    <div class="modal-body">
      <form onsubmit="event.preventDefault(); executarOperacaoAnalise();" class="rb-form lefted single-col">
        <div class="operacao-info">
          <img id="operacaoLogo" src="img/petr4.png" alt="Logo" class="logo-mini">
          <div>
            <h4 id="operacaoAtivo">PETR4</h4>
            <p>Pre√ßo atual: R$ <span id="operacaoPreco">0,00</span></p>
          </div>
        </div>
        
        <label>Quantidade (m√∫ltiplos de 100)
          <input type="number" id="operacaoQuantidade" class="rb-input input-royal-focus" placeholder="100, 200, 300..." required min="100" step="100">
        </label>
        
        <label>Valor por lote (R$)
          <input type="number" id="operacaoValor" class="rb-input input-royal-focus" placeholder="0,00" required step="0.01" min="0.01">
        </label>
        
        <div class="operacao-total">
          <strong>Total da opera√ß√£o: R$ <span id="operacaoTotal">0,00</span></strong>
        </div>
        
        <button class="btn-royal rb-enter" type="submit" id="btnExecutarOperacao">Executar <span id="tipoOperacaoBtn">Compra</span></button>
        <div id="operacaoMsg" class="error" role="alert"></div>
      </form>
    </div>
  </div>

  <script src="analise.js"></script>
  <script>
    // Atualizar total da opera√ß√£o
    document.getElementById('operacaoQuantidade')?.addEventListener('input', calcularTotalOperacao);
    document.getElementById('operacaoValor')?.addEventListener('input', calcularTotalOperacao);
    
    function calcularTotalOperacao() {
      const quantidade = parseInt(document.getElementById('operacaoQuantidade')?.value || 0);
      const valor = parseFloat(document.getElementById('operacaoValor')?.value || 0);
      const total = quantidade * valor;
      document.getElementById('operacaoTotal').textContent = total.toFixed(2);
    }
    
    function abrirOperacao(tipo) {
      const ativo = document.getElementById('anaSymbol')?.value || 'PETR4';
      const preco = ativosB3[ativo] || 0;
      
      document.getElementById('tipoOperacao').textContent = tipo;
      document.getElementById('tipoOperacaoBtn').textContent = tipo;
      document.getElementById('operacaoAtivo').textContent = ativo;
      document.getElementById('operacaoLogo').src = logos[ativo] || 'img/royal-logo.png';
      document.getElementById('operacaoPreco').textContent = preco.toFixed(2);
      document.getElementById('operacaoValor').value = preco.toFixed(2);
      document.getElementById('operacaoQuantidade').value = '';
      document.getElementById('operacaoTotal').textContent = '0,00';
      document.getElementById('operacaoMsg').textContent = '';
      
      showModal('modalOperacao');
    }
    
    function executarOperacaoAnalise() {
      const tipo = document.getElementById('tipoOperacao').textContent;
      const ativo = document.getElementById('operacaoAtivo').textContent;
      const quantidade = parseInt(document.getElementById('operacaoQuantidade').value);
      const valor = parseFloat(document.getElementById('operacaoValor').value);
      const msg = document.getElementById('operacaoMsg');
      
      if (!quantidade || !valor) {
        msg.className = 'error';
        msg.textContent = 'Preencha todos os campos obrigat√≥rios.';
        return;
      }
      
      if (quantidade % 100 !== 0) {
        msg.className = 'error';
        msg.textContent = 'Quantidade deve ser m√∫ltipla de 100.';
        return;
      }
      
      // Simular execu√ß√£o da opera√ß√£o
      const cotacao = ativosB3[ativo] || 0;
      const diferenca = Math.abs(valor - cotacao);
      
      if (diferenca <= 5) {
        // Opera√ß√£o executada ou aceita
        const status = diferenca === 0 ? 'Executada' : 'Aceita';
        
        // Adicionar ao extrato se executada
        if (status === 'Executada') {
          const operacao = {
            date: new Date(),
            tipo: tipo,
            ativo: ativo,
            qtd: quantidade,
            price: valor,
            total: quantidade * valor
          };
          
          // Atualizar carteira e saldo
          if (tipo === 'Compra') {
            if (usuarioAtual.saldo >= quantidade * valor) {
              usuarioAtual.saldo -= quantidade * valor;
              usuarioAtual.carteira[ativo] = (usuarioAtual.carteira[ativo] || 0) + quantidade;
              usuarioAtual.precoMedio[ativo] = valor;
              extrato.unshift(operacao);
              savePortfolioForUser(cpfAtual);
            } else {
              msg.className = 'error';
              msg.textContent = 'Saldo insuficiente para esta opera√ß√£o.';
              return;
            }
          } else if (tipo === 'Venda') {
            if (usuarioAtual.carteira[ativo] >= quantidade) {
              usuarioAtual.saldo += quantidade * valor;
              usuarioAtual.carteira[ativo] -= quantidade;
              if (usuarioAtual.carteira[ativo] === 0) {
                delete usuarioAtual.carteira[ativo];
                delete usuarioAtual.precoMedio[ativo];
              }
              extrato.unshift(operacao);
              savePortfolioForUser(cpfAtual);
            } else {
              msg.className = 'error';
              msg.textContent = 'Quantidade insuficiente na carteira para venda.';
              return;
            }
          }
        }
        
        msg.className = 'success';
        msg.textContent = `Ordem ${status.toLowerCase()} com sucesso!`;
        
        setTimeout(() => {
          hideModal('modalOperacao');
          // Atualizar carteira na tela
          montarMiniWallet();
        }, 1500);
        
      } else {
        msg.className = 'error';
        msg.textContent = 'Ordem rejeitada. Diferen√ßa muito grande em rela√ß√£o √† cota√ß√£o atual.';
      }
    }
  </script>
</body>
</html>